<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN管理系统</title>
    <!-- Bootstrap 3 CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        /* 仅添加必要的对齐样式和进度条调整 */
        .navbar .container {
            padding-left: 15px;
            padding-right: 15px;
        }

        body {
            padding-top: 50px;
        }

        .progress {
            margin-bottom: 5px;
            height: 10px;
        }

        .progress-info {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <!-- 深色导航栏 -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#navbar-collapse">
                    <span class="sr-only">切换导航</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/admin">VPN管理系统</a>
            </div>

            <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">状态 <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="/admin">概览</a></li>
                            <li><a href="route.html">路由</a></li>
                            <li><a href="iptables.html">防火墙</a></li>
                            <li><a href="onlineuser.html">在线用户</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">VPN系统 <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="vpn.html">概览</a></li>
                            <li><a href="vpnclient.html">VPN在线客户端</a></li>
                            <li><a href="vpnconfig.html">VPN配置</a></li>
                        </ul>
                    </li>
                    <li><a href="usermanager.html">用户管理</a></li>
                    <li><a href="rolemanager.html">角色管理</a></li>
                    <li><a href="networkmanager.html">网络组管理</a></li>
                </ul>

                <div class="navbar-right">
                    <ul class="nav navbar-nav">
                        <li><a href="?"><span class="glyphicon glyphicon-refresh"></span> 刷新</a></li>
                        <li><a href="/download.html" target="_blank"><span
                                    class=".glyphicon .glyphicon-download"></span> 下载客户端配置</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="myname">我</span><span
                                    class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="userconfig.html">用户配置</a></li>
                                <li><a href="javascript:void(0);" onclick="logout()">退出</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 - 浅色背景 -->
    <div class="container">
        <h2>状态</h2>

        <!-- 系统信息 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">系统</h3>
            </div>
            <div class="panel-body">
                <table class="table table-bordered table-striped">
                    <tr>
                        <td width="33%">主机名</td>
                        <td id="hostname">Loading...</td>
                    </tr>
                    <tr>
                        <td>型号</td>
                        <td id="model">Loading...</td>
                    </tr>
                    <tr>
                        <td>处理器</td>
                        <td id="cpuname">Loading...</td>
                    </tr>
                    <tr>
                        <td>架构</td>
                        <td id="arch">Loading...</td>
                    </tr>
                    <tr>
                        <td>系统版本</td>
                        <td id="target">Loading...</td>
                    </tr>
                    <tr>
                        <td>内核版本</td>
                        <td id="kernel">Loading...</td>
                    </tr>
                    <tr>
                        <td>本地时间</td>
                        <td id="localtime">Loading...</td>
                    </tr>
                    <tr>
                        <td>运行时间</td>
                        <td id="uptime">Loading...</td>
                    </tr>
                    <tr>
                        <td>系统平均负载</td>
                        <td id="overload">Loading...</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- 处理器负载信息 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">处理器负载</h3>
            </div>
            <div class="panel-body">
                <table class="table table-bordered table-striped" >
                    <tbody id="cpuList"></tbody>
                </table>
            </div>
        </div>

        <!-- 内存信息 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">内存</h3>
            </div>
            <div class="panel-body">
                <table class="table table-bordered table-striped">
                    <tr>
                        <td width="33%">可用数</td>
                        <td>
                            <div id="available" class="progress-info">0 MiB / 0 MiB (0%)</div>
                            <div class="progress">
                                <div id="availableProc" class="progress-bar" style="width:0%"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>已使用</td>
                        <td>
                            <div id="used" class="progress-info">0 MiB / 0 MiB (0%)</div>
                            <div class="progress">
                                <div id="usedProc" class="progress-bar" style="width:0%"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>已缓冲</td>
                        <td>
                            <div id="buffers" class="progress-info">0 MiB / 0 MiB (0%)</div>
                            <div class="progress">
                                <div id="buffersProc" class="progress-bar" style="width:0%"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>已缓存</td>
                        <td>
                            <div id="cached" class="progress-info">0 MiB / 0 MiB (0%)</div>
                            <div class="progress">
                                <div id="cachedProc" class="progress-bar" style="width:0%"></div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- 存储空间 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">存储空间使用情况</h3>
            </div>
            <div class="panel-body">
                <table class="table table-bordered table-striped">
                    <tbody id="diskList"></tbody>
                </table>
            </div>
        </div>

        <!-- 网络信息 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">网络接口</h3>
            </div>
            <div class="panel-body" id="ifaceList">
            </div>
                
            <!-- 
            <table class="table table-bordered table-striped">
                <tr>
                    <td width="33%">活动连接</td>
                    <td>
                        <div class="progress-info">46 / 63488 (0%)</div>
                        <div class="progress">
                            <div class="progress-bar" style="width:0%"></div>
                        </div>
                    </td>
                </tr>
            </table> -->
        </div>


    </div>

    <!-- 页脚 -->
    <footer class="navbar navbar-default">
        <div class="container">
            <p class="navbar-text">
                <a href="https://github.com/twbs/bootstrap">Powered by Bootstrap 3.4.1 </a> / VPN-Management 0.1
            </p>
        </div>
    </footer>

    <!-- 引入本地jQuery和Bootstrap JS -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>

    <!-- 引入本地模态框 -->
    <script src="/static/js/modal.js"></script>
    <script src="/static/js/public.js"></script>

    <script>
        function init() {
            $.ajax({
                url: "/api/system/systemInfo",
                method: "POST",
                timeout: 10000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let data = res.data;
                let load0 = parseInt(data.loadavg[0] * 100);
                let load1 = parseInt(data.loadavg[1] * 100);
                let load2 = parseInt(data.loadavg[2] * 100);
                $('#hostname').text(data.hostname);
                $('#model').text(data.model);
                $('#cpuname').text(data.cpuname);
                $('#arch').text(data.arch);
                $('#target').text(data.target);
                $('#kernel').text(data.kernel);
                $('#localtime').text(data.localtime);
                $('#uptime').text(data.uptime);
                $('#overload').text(`${load0}%(1分钟内) - ${load1}%(5分钟内) - ${load2}%(15分钟内)`);
            })).fail(handleXhrFail);
        }

        function looper() {
            getMemInfo();
            getCpuInfo();
            getDiskInfo();
            getIfaceInfo();
            getLoadavg();
        }

        function getMemInfo() {
            $.ajax({
                url: "/api/system/memInfo",
                method: "POST",
                timeout: 5000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let data = res.data;
                let available = parseInt(data.available / data.total * 100);
                let used = parseInt(data.used / data.total * 100);
                let buffers = parseInt(data.buffers / data.total * 100);
                let cached = parseInt(data.cached / data.total * 100);

                $('#available').text(`${data.available} MiB / ${data.total} MiB (${available}%)`);
                $('#used').text(`${data.used} MiB / ${data.total} MiB (${used}%)`);
                $('#buffers').text(`${data.buffers} MiB / ${data.total} MiB (${buffers}%)`);
                $('#cached').text(`${data.cached} MiB / ${data.total} MiB (${cached}%)`);

                $('#availableProc').css('width', `${available}%`);
                $('#usedProc').css('width', `${used}%`);
                $('#buffersProc').css('width', `${buffers}%`);
                $('#cachedProc').css('width', `${cached}%`);
            })).fail(handleXhrFail);
        }

        function getCpuInfo() {
            $.ajax({
                url: "/api/system/cpuInfo",
                method: "POST",
                timeout: 5000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let cpus = res.data.cpus;
                let cpuList = $('#cpuList');
                cpuList.empty();
                for (let i=0;i<cpus.length;i++) {
                    let load = cpus[i].load.toFixed(2);
                    let tr = $(`
                        <tr>
                            <td width="33%">CPU-${i}</td>
                            <td>
                                <div class="progress-info">当前利用率 (${load}%)</div>
                                <div class="progress">
                                    <div class="progress-bar" style="width:${parseInt(load)}%"></div>
                                </div>
                            </td>
                        </tr>`);
                    cpuList.append(tr);
                }
                
            })).fail(handleXhrFail);
        }

        function getDiskInfo() {
            $.ajax({
                url: "/api/system/diskInfo",
                method: "POST",
                timeout: 5000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let disks = res.data;
                let diskList = $('#diskList');
                diskList.empty();
                for (let disk of disks) {
                    let tr = $(`
                        <tr>
                            <td width="33%">
                                <div>挂载点: ${disk.mount}</div>
                                <div>设备: ${disk.fs}</div>
                                <div>文件系统: ${disk.type} 挂载状态: ${disk.rw?'读写':'只读'}</div>
                            </td>
                            <td>
                                <div class="progress-info">${disk.used} MiB / ${disk.size} MiB (${disk.use}%)</div>
                                <div class="progress">
                                    <div class="progress-bar" style="width:${parseInt(disk.use)}%"></div>
                                </div>
                            </td>
                        </tr>`);
                    diskList.append(tr);
                }
                
            })).fail(handleXhrFail);
        }

        function getIfaceInfo() {
            $.ajax({
                url: "/api/system/netInfo",
                method: "POST",
                timeout: 5000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let ifaces = res.data;
                let ifaceList = $('#ifaceList');
                ifaceList.empty();
                for (let iface of ifaces) {
                    if (iface.internal)
                        continue;
                    let tr = $(`
                        <div class="panel ${iface.default?'panel-success':'panel-info'}">
                            <div class="panel-heading">
                                <strong>接口: ${iface.ifaceName} ${iface.default?'(默认接口)':''}</strong>
                            </div>
                            <div class="panel-body">
                                <p><strong>协议：</strong>${iface.dhcp?'DHCP客户端':'静态地址'}</p>
                                <p><strong>地址：</strong>${iface.ip4}/${iface.ip4subnet}</p>
                                <p><strong>设备类型：</strong>${iface.type}</p>
                                <p><strong>MTU大小：</strong>${iface.mtu}</p>
                                <p><strong>连接速度：</strong>${iface.speed}Mbps (${iface.duplex?'全双工':'半双工'})</p>
                                <p><strong>虚拟网卡：</strong>${iface.virtual?'是':'否'}</p>
                                <p><strong>MAC 地址：</strong>${iface.mac}</p>
                            </div>
                        </div>`);
                    if (iface.default == true)
                        ifaceList.prepend(tr)
                    else
                        ifaceList.append(tr);
                }

                
            })).fail(handleXhrFail);
        }
        
        function getLoadavg() {
            $.ajax({
                url: "/api/system/systemInfo",
                method: "POST",
                timeout: 10000,
                headers: { "authorization": localStorage.getItem('authToken') }
                ,
            }).done(checkResCode(res => {
                let data = res.data;
                let load0 = parseInt(data.loadavg[0] * 100);
                let load1 = parseInt(data.loadavg[1] * 100);
                let load2 = parseInt(data.loadavg[2] * 100);
                $('#overload').text(`${load0}%(1分钟内) - ${load1}%(5分钟内) - ${load2}%(15分钟内)`);
            })).fail(handleXhrFail);
        }

        init();
        looper();
        setInterval(looper, 5000);
    </script>
</body>

</html>